#+TITLE: LangChain æ ¸å¿ƒæ¨¡å—å­¦ä¹ ï¼šChainsï¼ˆsequential_chainï¼‰
#+STARTUP: showall hidestars indent inlineimages
#+PROPERTY: header-args:jupyter-python :session 2024äººå·¥æ™ºèƒ½å­¦ä¹ -LangChain-chains-sequential :display text/plain

å¯¹äºç®€å•çš„å¤§æ¨¡å‹åº”ç”¨ï¼Œå•ç‹¬ä½¿ç”¨è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰æ˜¯å¯ä»¥çš„ã€‚

*ä½†æ›´å¤æ‚çš„å¤§æ¨¡å‹åº”ç”¨éœ€è¦å°† =LLMs= å’Œ =Chat Models= é“¾æ¥åœ¨ä¸€èµ· - è¦ä¹ˆå½¼æ­¤é“¾æ¥ï¼Œè¦ä¹ˆä¸å…¶ä»–ç»„ä»¶é“¾æ¥ã€‚*

LangChain ä¸ºè¿™ç§â€œé“¾å¼â€åº”ç”¨ç¨‹åºæä¾›äº† =Chain= æ¥å£ã€‚

LangChain ä»¥é€šç”¨æ–¹å¼å®šä¹‰äº† =Chain= ï¼Œå®ƒæ˜¯å¯¹ç»„ä»¶è¿›è¡Œè°ƒç”¨åºåˆ—çš„é›†åˆï¼Œå…¶ä¸­å¯ä»¥åŒ…å«å…¶ä»–é“¾ã€‚

* Chain Class åŸºç±»
ç±»ç»§æ‰¿å…³ç³»ï¼š

#+begin_example
Chain --> <name>Chain  # Examples: LLMChain, MapReduceChain, RouterChain
#+end_example

*ä»£ç å®ç°ï¼š[[https://github.com/langchain-ai/langchain/blob/master/libs/langchain/langchain/chains/base.py]]*

#+begin_src python :eval no
  # å®šä¹‰ä¸€ä¸ªåä¸ºChainçš„åŸºç¡€ç±»
  class Chain(Serializable, Runnable[Dict[str, Any], Dict[str, Any]], ABC):
      """ä¸ºåˆ›å»ºç»“æ„åŒ–çš„ç»„ä»¶è°ƒç”¨åºåˆ—çš„æŠ½è±¡åŸºç±»ã€‚
    
      é“¾åº”è¯¥ç”¨æ¥ç¼–ç å¯¹ç»„ä»¶çš„ä¸€ç³»åˆ—è°ƒç”¨ï¼Œå¦‚æ¨¡å‹ã€æ–‡æ¡£æ£€ç´¢å™¨ã€å…¶ä»–é“¾ç­‰ï¼Œå¹¶ä¸ºæ­¤åºåˆ—æä¾›ä¸€ä¸ªç®€å•çš„æ¥å£ã€‚
    
      Chainæ¥å£ä½¿åˆ›å»ºåº”ç”¨ç¨‹åºå˜å¾—å®¹æ˜“ï¼Œè¿™äº›åº”ç”¨ç¨‹åºæ˜¯ï¼š
      - æœ‰çŠ¶æ€çš„ï¼šç»™ä»»ä½•Chainæ·»åŠ Memoryå¯ä»¥ä½¿å®ƒå…·æœ‰çŠ¶æ€ï¼Œ
      - å¯è§‚å¯Ÿçš„ï¼šå‘Chainä¼ é€’Callbacksæ¥æ‰§è¡Œé¢å¤–çš„åŠŸèƒ½ï¼Œå¦‚è®°å½•ï¼Œè¿™åœ¨ä¸»è¦çš„ç»„ä»¶è°ƒç”¨åºåˆ—ä¹‹å¤–ï¼Œ
      - å¯ç»„åˆçš„ï¼šChain APIè¶³å¤Ÿçµæ´»ï¼Œå¯ä»¥è½»æ¾åœ°å°†Chainsä¸å…¶ä»–ç»„ä»¶ç»“åˆèµ·æ¥ï¼ŒåŒ…æ‹¬å…¶ä»–Chainsã€‚
    
      é“¾å…¬å¼€çš„ä¸»è¦æ–¹æ³•æ˜¯ï¼š
      - `__call__`ï¼šé“¾æ˜¯å¯ä»¥è°ƒç”¨çš„ã€‚`__call__`æ–¹æ³•æ˜¯æ‰§è¡ŒChainçš„ä¸»è¦æ–¹å¼ã€‚å®ƒå°†è¾“å…¥ä½œä¸ºä¸€ä¸ªå­—å…¸æ¥æ”¶ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—å…¸è¾“å‡ºã€‚
      - `run`ï¼šä¸€ä¸ªæ–¹ä¾¿çš„æ–¹æ³•ï¼Œå®ƒä»¥args/kwargsçš„å½¢å¼æ¥æ”¶è¾“å…¥ï¼Œå¹¶å°†è¾“å‡ºä½œä¸ºå­—ç¬¦ä¸²æˆ–å¯¹è±¡è¿”å›ã€‚è¿™ç§æ–¹æ³•åªèƒ½ç”¨äºä¸€éƒ¨åˆ†é“¾ï¼Œä¸èƒ½åƒ`__call__`é‚£æ ·è¿”å›ä¸°å¯Œçš„è¾“å‡ºã€‚
      """

      # è°ƒç”¨é“¾
      def invoke(
          self, input: Dict[str, Any], config: Optional[runnableConfig] = None
      ) -> Dict[str, Any]:
          """ä¼ ç»Ÿè°ƒç”¨æ–¹æ³•ã€‚"""
          return self(input, **(config or {}))

      # é“¾çš„è®°å¿†ï¼Œä¿å­˜çŠ¶æ€å’Œå˜é‡
      memory: Optional[BaseMemory] = None
      """å¯é€‰çš„å†…å­˜å¯¹è±¡ï¼Œé»˜è®¤ä¸ºNoneã€‚
      å†…å­˜æ˜¯ä¸€ä¸ªåœ¨æ¯ä¸ªé“¾çš„å¼€å§‹å’Œç»“æŸæ—¶è¢«è°ƒç”¨çš„ç±»ã€‚åœ¨å¼€å§‹æ—¶ï¼Œå†…å­˜åŠ è½½å˜é‡å¹¶åœ¨é“¾ä¸­ä¼ é€’å®ƒä»¬ã€‚åœ¨ç»“æŸæ—¶ï¼Œå®ƒä¿å­˜ä»»ä½•è¿”å›çš„å˜é‡ã€‚
      æœ‰è®¸å¤šä¸åŒç±»å‹çš„å†…å­˜ï¼Œè¯·æŸ¥çœ‹å†…å­˜æ–‡æ¡£ä»¥è·å–å®Œæ•´çš„ç›®å½•ã€‚"""

      # å›è°ƒï¼Œå¯èƒ½ç”¨äºé“¾çš„æŸäº›æ“ä½œæˆ–äº‹ä»¶ã€‚
      callbacks: Callbacks = Field(default=None, exclude=True)
      """å¯é€‰çš„å›è°ƒå¤„ç†ç¨‹åºåˆ—è¡¨ï¼ˆæˆ–å›è°ƒç®¡ç†å™¨ï¼‰ã€‚é»˜è®¤ä¸ºNoneã€‚
      åœ¨å¯¹é“¾çš„è°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œä»on_chain_startå¼€å§‹ï¼Œåˆ°on_chain_endæˆ–on_chain_errorç»“æŸï¼Œéƒ½ä¼šè°ƒç”¨å›è°ƒå¤„ç†ç¨‹åºã€‚
      æ¯ä¸ªè‡ªå®šä¹‰é“¾å¯ä»¥é€‰æ‹©è°ƒç”¨é¢å¤–çš„å›è°ƒæ–¹æ³•ï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚è§Callbackæ–‡æ¡£ã€‚"""

      # æ˜¯å¦è¯¦ç»†è¾“å‡ºæ¨¡å¼
      verbose: bool = Field(default_factory=_get_verbosity)
      """æ˜¯å¦ä»¥è¯¦ç»†æ¨¡å¼è¿è¡Œã€‚åœ¨è¯¦ç»†æ¨¡å¼ä¸‹ï¼Œä¸€äº›ä¸­é—´æ—¥å¿—å°†æ‰“å°åˆ°æ§åˆ¶å°ã€‚é»˜è®¤å€¼ä¸º`langchain.verbose`ã€‚"""

      # ä¸é“¾å…³è”çš„æ ‡ç­¾
      tags: Optional[List[str]] = None
      """ä¸é“¾å…³è”çš„å¯é€‰æ ‡ç­¾åˆ—è¡¨ï¼Œé»˜è®¤ä¸ºNoneã€‚
      è¿™äº›æ ‡ç­¾å°†ä¸å¯¹è¿™ä¸ªé“¾çš„æ¯æ¬¡è°ƒç”¨å…³è”èµ·æ¥ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™åœ¨`callbacks`ä¸­å®šä¹‰çš„å¤„ç†ç¨‹åºã€‚
      ä½ å¯ä»¥ä½¿ç”¨è¿™äº›æ¥ä¾‹å¦‚è¯†åˆ«é“¾çš„ç‰¹å®šå®ä¾‹ä¸å…¶ç”¨ä¾‹ã€‚"""

      # ä¸é“¾å…³è”çš„å…ƒæ•°æ®
      metadata: Optional[Dict[str, Any]] = None
      """ä¸é“¾å…³è”çš„å¯é€‰å…ƒæ•°æ®ï¼Œé»˜è®¤ä¸ºNoneã€‚
      è¿™äº›å…ƒæ•°æ®å°†ä¸å¯¹è¿™ä¸ªé“¾çš„æ¯æ¬¡è°ƒç”¨å…³è”èµ·æ¥ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ é€’ç»™åœ¨`callbacks`ä¸­å®šä¹‰çš„å¤„ç†ç¨‹åºã€‚
      ä½ å¯ä»¥ä½¿ç”¨è¿™äº›æ¥ä¾‹å¦‚è¯†åˆ«é“¾çš„ç‰¹å®šå®ä¾‹ä¸å…¶ç”¨ä¾‹ã€‚"""
#+end_src

* LLMChain
LLMChain æ˜¯ LangChain ä¸­æœ€ç®€å•çš„é“¾ï¼Œä½œä¸ºå…¶ä»–å¤æ‚ Chains å’Œ Agents çš„å†…éƒ¨è°ƒç”¨ï¼Œè¢«å¹¿æ³›åº”ç”¨ã€‚

ä¸€ä¸ªLLMChainç”±PromptTemplateå’Œè¯­è¨€æ¨¡å‹ï¼ˆLLM or Chat Modelï¼‰ç»„æˆã€‚
å®ƒä½¿ç”¨ç›´æ¥ä¼ å…¥ï¼ˆæˆ– memory æä¾›ï¼‰çš„ key-value æ¥è§„èŒƒåŒ–ç”Ÿæˆ Prompt Templateï¼ˆæç¤ºæ¨¡æ¿ï¼‰ï¼Œå¹¶å°†ç”Ÿæˆçš„ prompt ï¼ˆæ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²ï¼‰ä¼ é€’ç»™å¤§æ¨¡å‹ï¼Œå¹¶è¿”å›å¤§æ¨¡å‹è¾“å‡ºã€‚

#+ATTR_ORG: :width 800
[[../images/llm_chain.png]]

#+begin_src jupyter-python :results none
  from pprint import pprint
  from langchain_openai import OpenAI
  from langchain.prompts import PromptTemplate

  base_url='https://api.xty.app/v1'

  llm = OpenAI(model_name="gpt-3.5-turbo-instruct", temperature=0.9, max_tokens=500, base_url=base_url)
#+end_src

#+begin_src jupyter-python :results none
  prompt = PromptTemplate(
      input_variables=["product"],
      template="ç»™åˆ¶é€ {product}çš„æœ‰é™å…¬å¸å–10ä¸ªå¥½åå­—ï¼Œå¹¶ç»™å‡ºå®Œæ•´çš„å…¬å¸åç§°",
  )
#+end_src

#+begin_src jupyter-python
  from langchain.chains import LLMChain

  chain = LLMChain(llm=llm, prompt=prompt)
  print(chain.run({
      'product': "æ€§èƒ½å“è¶Šçš„GPU"
      }))
#+end_src

#+RESULTS:
#+begin_example
  /Users/wangjian/.virtualenvs/jupyter/lib/python3.12/site-packages/langchain_core/_api/deprecation.py:119: LangChainDeprecationWarning: The class `LLMChain` was deprecated in LangChain 0.1.17 and will be removed in 0.3.0. Use RunnableSequence, e.g., `prompt | llm` instead.
    warn_deprecated(
  /Users/wangjian/.virtualenvs/jupyter/lib/python3.12/site-packages/langchain_core/_api/deprecation.py:119: LangChainDeprecationWarning: The method `Chain.run` was deprecated in langchain 0.1.0 and will be removed in 0.3.0. Use invoke instead.
    warn_deprecated(


  1. é€Ÿç¿¼ç§‘æŠ€æœ‰é™å…¬å¸ (SwiftWing Technologies Co., Ltd.)
  2. å¼ºåŠ›æ™¶è¿…æœ‰é™å…¬å¸ (PowerCrystal Xun Co., Ltd.)
  3. ç£çŸ³ç§‘æŠ€æœ‰é™å…¬å¸ (RockTech Solutions Co., Ltd.)
  4. æå…‰å“è¶Šæœ‰é™å…¬å¸ (Aurora Excellence Co., Ltd.)
  5. ç‚é¾™åˆ¶é€ æœ‰é™å…¬å¸ (FlameDragon Fabrications Co., Ltd.)
  6. æ˜Ÿæ ¸ç§‘æŠ€æœ‰é™å…¬å¸ (StarCore Technologies Co., Ltd.)
  7. åˆ›å¯¼é«˜æ€§èƒ½æœ‰é™å…¬å¸ (Innovate High-Performance Co., Ltd.)
  8. é£é¸Ÿç§‘æŠ€æœ‰é™å…¬å¸ (FlyingBird Technologies Co., Ltd.)
  9. è¶…è¶Šè§†ç•Œæœ‰é™å…¬å¸ (BeyondVision Solutions Co., Ltd.)
  10. ç„šç„°åˆ›æ–°æœ‰é™å…¬å¸ (BlazeInnovate Co., Ltd.)
#+end_example

#+begin_src jupyter-python :results none
  chain.verbose = True
#+end_src

#+begin_src jupyter-python
  chain.verbose
#+end_src

#+RESULTS:
: True
#+begin_src jupyter-python
  print(chain.run({
      'product': "æ€§èƒ½å“è¶Šçš„GPU"
      }))
#+end_src

#+RESULTS:
#+begin_example


  [1m> Entering new LLMChain chain...[0m
  Prompt after formatting:
  [32;1m[1;3mç»™åˆ¶é€ æ€§èƒ½å“è¶Šçš„GPUçš„æœ‰é™å…¬å¸å–10ä¸ªå¥½åå­—ï¼Œå¹¶ç»™å‡ºå®Œæ•´çš„å…¬å¸åç§°[0m

  [1m> Finished chain.[0m



  1. åˆ›æ–°è§†ç•Œç§‘æŠ€æœ‰é™å…¬å¸
  2. å…ˆé”‹å›¾åƒç§‘æŠ€æœ‰é™å…¬å¸
  3. å¼ºåŠ²è§†ç•ŒåŠå¯¼ä½“æœ‰é™å…¬å¸
  4. æè‡´è®¡ç®—ç§‘æŠ€æœ‰é™å…¬å¸
  5. æ™ºèƒ½å›¾åƒè§£å†³æ–¹æ¡ˆæœ‰é™å…¬å¸
  6. é£è·ƒåŠå¯¼ä½“ç§‘æŠ€æœ‰é™å…¬å¸
  7. é«˜ç«¯å›¾åƒå¤„ç†ç§‘æŠ€æœ‰é™å…¬å¸
  8. å…¨æ–°è§†è§‰ç§‘æŠ€æœ‰é™å…¬å¸
  9. å¤©é©¬è¡Œç©ºå›¾åƒç§‘æŠ€æœ‰é™å…¬å¸
  10. æºæºä¸æ–­åŠå¯¼ä½“ç§‘æŠ€æœ‰é™å…¬å¸
#+end_example

* Sequential Chain
ä¸²è”å¼è°ƒç”¨è¯­è¨€æ¨¡å‹ï¼ˆå°†ä¸€ä¸ªè°ƒç”¨çš„è¾“å‡ºä½œä¸ºå¦ä¸€ä¸ªè°ƒç”¨çš„è¾“å…¥ï¼‰ã€‚

é¡ºåºé“¾ï¼ˆSequential Chainï¼‰å…è®¸ç”¨æˆ·è¿æ¥å¤šä¸ªé“¾å¹¶å°†å®ƒä»¬ç»„åˆæˆæ‰§è¡Œç‰¹å®šåœºæ™¯çš„æµæ°´çº¿ï¼ˆPipelineï¼‰ã€‚
æœ‰ä¸¤ç§ç±»å‹çš„é¡ºåºé“¾ï¼š

- SimpleSequentialChainï¼šæœ€ç®€å•å½¢å¼çš„é¡ºåºé“¾ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½å…·æœ‰å•ä¸€è¾“å…¥/è¾“å‡ºï¼Œå¹¶ä¸”ä¸€ä¸ªæ­¥éª¤çš„è¾“å‡ºæ˜¯ä¸‹ä¸€ä¸ªæ­¥éª¤çš„è¾“å…¥ã€‚
- SequentialChainï¼šæ›´é€šç”¨å½¢å¼çš„é¡ºåºé“¾ï¼Œå…è®¸å¤šä¸ªè¾“å…¥/è¾“å‡ºã€‚

** ä½¿ç”¨ SimpleSequentialChain å®ç°æˆå‰§æ‘˜è¦å’Œè¯„è®ºï¼ˆå•è¾“å…¥/å•è¾“å‡ºï¼‰
#+ATTR_ORG: :width 800
[[../images/simple_sequential_chain_0.png]]

#+begin_src jupyter-python :results none
  # è¿™æ˜¯ä¸€ä¸ª LLMChainï¼Œç”¨äºæ ¹æ®å‰§ç›®çš„æ ‡é¢˜æ’°å†™ç®€ä»‹ã€‚

  llm = OpenAI(temperature=0.7, max_tokens=1000, base_url=base_url)

  template = """ä½ æ˜¯ä¸€ä½å‰§ä½œå®¶ã€‚æ ¹æ®æˆå‰§çš„æ ‡é¢˜ï¼Œä½ çš„ä»»åŠ¡æ˜¯ä¸ºè¯¥æ ‡é¢˜å†™ä¸€ä¸ªç®€ä»‹ã€‚

  æ ‡é¢˜ï¼š{title}
  å‰§ä½œå®¶ï¼šä»¥ä¸‹æ˜¯å¯¹ä¸Šè¿°æˆå‰§çš„ç®€ä»‹ï¼š"""

  prompt_template = PromptTemplate(input_variables=["title"], template=template)
  synopsis_chain = LLMChain(llm=llm, prompt=prompt_template)
#+end_src

#+begin_src jupyter-python :results none
  # è¿™æ˜¯ä¸€ä¸ªLLMChainï¼Œç”¨äºæ ¹æ®å‰§æƒ…ç®€ä»‹æ’°å†™ä¸€ç¯‡æˆå‰§è¯„è®ºã€‚
  # llm = OpenAI(temperature=0.7, max_tokens=1000)
  template = """ä½ æ˜¯ã€Šçº½çº¦æ—¶æŠ¥ã€‹çš„æˆå‰§è¯„è®ºå®¶ã€‚æ ¹æ®å‰§æƒ…ç®€ä»‹ï¼Œä½ çš„å·¥ä½œæ˜¯ä¸ºè¯¥å‰§æ’°å†™ä¸€ç¯‡è¯„è®ºã€‚

  å‰§æƒ…ç®€ä»‹ï¼š
  {synopsis}

  ä»¥ä¸‹æ˜¯æ¥è‡ªã€Šçº½çº¦æ—¶æŠ¥ã€‹æˆå‰§è¯„è®ºå®¶å¯¹ä¸Šè¿°å‰§ç›®çš„è¯„è®ºï¼š"""

  prompt_template = PromptTemplate(input_variables=["synopsis"], template=template)
  review_chain = LLMChain(llm=llm, prompt=prompt_template)
#+end_src

#+ATTR_ORG: :width 800
[[../images/simple_sequential_chain_1.png]]

#+begin_src jupyter-python :results none
  # è¿™æ˜¯ä¸€ä¸ªSimpleSequentialChainï¼ŒæŒ‰é¡ºåºè¿è¡Œè¿™ä¸¤ä¸ªé“¾
  from langchain.chains import SimpleSequentialChain

  overall_chain = SimpleSequentialChain(chains=[synopsis_chain, review_chain], verbose=True)
#+end_src

#+begin_src jupyter-python
  review = overall_chain.run("ä¸‰ä½“äººä¸æ˜¯æ— æ³•æˆ˜èƒœçš„")
#+end_src

#+RESULTS:
#+begin_example


  [1m> Entering new SimpleSequentialChain chain...[0m
  [36;1m[1;3m

  ã€Šä¸‰ä½“äººä¸æ˜¯æ— æ³•æˆ˜èƒœçš„ã€‹è®²è¿°äº†ä¸€ä¸ªå…³äºäººç±»å’Œå¤–æ˜Ÿç§æ—ä¸‰ä½“äººçš„æ•…äº‹ã€‚åœ¨æœªæ¥ï¼Œäººç±»å‘ç°äº†ä¸€é¢—å®‡å®™ä¸­å¿ƒçš„æ˜Ÿçƒï¼Œå®ƒè¢«ç§°ä¸ºä¸‰ä½“ä¸–ç•Œï¼Œè¿™é‡Œçš„ç”Ÿç‰©æ‹¥æœ‰è¶…å¼ºçš„ç§‘æŠ€èƒ½åŠ›å’Œä¸å¯æ€è®®çš„æ™ºæ…§ã€‚äººç±»ä¸ä¸‰ä½“äººå¼€å§‹äº†ä¸€åœºæ®Šæ­»çš„æˆ˜äº‰ï¼ŒåŒæ–¹éƒ½æƒ³è¦æ‘§æ¯å¯¹æ–¹ï¼Œä½†æ˜¯éšç€æˆ˜äº‰çš„è¿›è¡Œï¼Œäººç±»å‘ç°ä¸‰ä½“äººå¹¶éæ— æ³•æˆ˜èƒœã€‚éšç€æ•…äº‹çš„å‘å±•ï¼Œäººç±»å’Œä¸‰ä½“äººä¹‹é—´çš„å…³ç³»å˜å¾—å¤æ‚èµ·æ¥ï¼Œä»–ä»¬å¼€å§‹æ€è€ƒæˆ˜äº‰çš„æ„ä¹‰å’Œè‡ªå·±çš„ç”Ÿå­˜ã€‚æœ€ç»ˆï¼Œäººç±»å’Œä¸‰ä½“äººè¾¾æˆäº†å’Œè§£ï¼Œå¹¶å…±åŒé¢å¯¹æ›´å¤§çš„å¨èƒã€‚è¿™éƒ¨æˆå‰§æ¢è®¨äº†æˆ˜äº‰ã€å’Œå¹³ã€æ™ºæ…§å’Œç”Ÿå­˜çš„ä¸»é¢˜ï¼Œå¸¦ç»™è§‚ä¼—æ·±åˆ»çš„æ€è€ƒã€‚[0m
  [33;1m[1;3m

  ã€Šä¸‰ä½“äººä¸æ˜¯æ— æ³•æˆ˜èƒœçš„ã€‹æ˜¯ä¸€éƒ¨ä»¤äººå°è±¡æ·±åˆ»çš„æˆå‰§ä½œå“ï¼Œå®ƒä»¥å®å¤§çš„å®‡å®™èƒŒæ™¯ä¸ºèˆå°ï¼Œæ¢è®¨äº†äººç±»å’Œå¤–æ˜Ÿç§æ—ä¸‰ä½“äººä¹‹é—´çš„å…³ç³»ã€‚è¯¥å‰§å¼•äººå…¥èƒœçš„å‰§æƒ…å’Œæ·±åˆ»çš„ä¸»é¢˜ï¼Œè®©è§‚ä¼—åœ¨è§‚çœ‹çš„åŒæ—¶ä¹Ÿæ·±æ€äººç±»çš„æœªæ¥å’Œæˆ‘ä»¬å¯¹æˆ˜äº‰çš„ç†è§£ã€‚

  å‰§ä¸­ï¼Œäººç±»å‘ç°äº†è¶…å¼ºç§‘æŠ€èƒ½åŠ›å’Œæ™ºæ…§çš„ä¸‰ä½“ä¸–ç•Œï¼Œå±•å¼€äº†ä¸€åœºæ®Šæ­»çš„æˆ˜äº‰ã€‚ç„¶è€Œï¼Œéšç€æˆ˜äº‰çš„è¿›è¡Œï¼Œäººç±»å‘ç°ä¸‰ä½“äººå¹¶éæ— æ³•æˆ˜èƒœï¼Œè¿™è®©ä»–ä»¬å¼€å§‹æ€è€ƒæˆ˜äº‰çš„æ„ä¹‰å’Œè‡ªèº«çš„ç”Ÿå­˜ã€‚å‰§ä¸­è§’è‰²çš„å¤æ‚æ€§å’Œæ¼”å‘˜ä»¬ç²¾æ¹›çš„è¡¨æ¼”ï¼Œè®©è§‚ä¼—ä¸ä»…ä»…æ˜¯è¢«åŠ¨çš„è§‚çœ‹ï¼Œè€Œæ˜¯è¢«å¸¦å…¥åˆ°æ•…äº‹ä¸­å»ï¼Œå’Œè§’è‰²ä¸€èµ·æ€è€ƒã€‚

  è¯¥å‰§è¿˜æ¢è®¨äº†å’Œå¹³ã€æ™ºæ…§å’Œç”Ÿå­˜çš„ä¸»é¢˜ã€‚é€šè¿‡äººç±»å’Œä¸‰ä½“äººä¹‹é—´çš„å¯¹è¯å’Œäº’åŠ¨ï¼Œè§‚ä¼—å¯ä»¥æ·±åˆ»æ„Ÿå—åˆ°æˆ˜äº‰å¯¹äººç±»çš„å½±å“ï¼Œä»¥åŠå’Œå¹³å¯¹äººç±»çš„é‡è¦æ€§ã€‚åŒæ—¶ï¼Œå‰§ä¸­å±•ç°çš„ä¸‰ä½“äººçš„æ™ºæ…§å’Œç§‘æŠ€èƒ½åŠ›ä¹Ÿè®©è§‚ä¼—åæ€äººç±»çš„æœªæ¥å‘å±•æ–¹å‘ã€‚

  æœ€ç»ˆï¼Œäººç±»å’Œä¸‰ä½“äººè¾¾æˆäº†å’Œè§£ï¼Œå¹¶å…±åŒé¢å¯¹æ›´å¤§çš„å¨èƒã€‚è¿™ç§å®½å®¹å’Œå›¢ç»“çš„æ€åº¦ï¼Œä¹Ÿè®©è§‚ä¼—æ„Ÿå—åˆ°æˆå‰§ä¸­è•´å«çš„ç§¯æå‘ä¸Šçš„åŠ›é‡ã€‚

  æ€»çš„æ¥è¯´ï¼Œã€Šä¸‰ä½“äººä¸æ˜¯æ— æ³•æˆ˜èƒœçš„ã€‹æ˜¯ä¸€éƒ¨å……æ»¡æ™ºæ…§å’Œæ€è€ƒçš„æˆå‰§ä½œå“ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€åœºå¨±ä¹ï¼Œæ›´æ˜¯ä¸€æ¬¡å…³äºäººç±»æœªæ¥å’Œå’Œå¹³çš„æ€è€ƒä¹‹æ—…ã€‚è§‚ä¼—ä»¬åœ¨æ¬£èµå‰§ä¸­ç²¾å½©çš„è¡¨æ¼”çš„åŒæ—¶ï¼Œä¹Ÿä¼šè¢«å¸¦å…¥åˆ°æ·±æ€çš„å¢ƒç•Œä¸­ã€‚è¿™éƒ¨æˆå‰§ç»å¯¹å€¼å¾—è§‚çœ‹ã€‚[0m

  [1m> Finished chain.[0m
#+end_example

#+begin_src jupyter-python
  review = overall_chain.run("æ˜Ÿçƒå¤§æˆ˜ç¬¬ä¹å­£")
#+end_src

#+RESULTS:
#+begin_example


  > Entering new SimpleSequentialChain chain...
  ã€Šæ˜Ÿçƒå¤§æˆ˜ç¬¬ä¹å­£ã€‹

  åœ¨è¿™éƒ¨æˆå‰§ä¸­ï¼Œé“¶æ²³ç³»å†æ¬¡é™·å…¥äº†æ··ä¹±å’Œå†²çªä¹‹ä¸­ã€‚ä¸€åœºæ–°çš„æˆ˜äº‰å³å°†çˆ†å‘ï¼Œæ—§çš„è”ç›Ÿå’Œæ–°çš„æ•Œäººä¹‹é—´çš„å¯¹æŠ—å†æ¬¡å¼•å‘äº†æ•´ä¸ªå®‡å®™çš„åŠ¨è¡ã€‚ç„¶è€Œï¼Œåœ¨è¿™ä¸ªåŠ¨è¡çš„æ—¶ä»£ï¼Œä¸€ç¾¤è‹±é›„å’ŒåæŠ—è€…å´›èµ·ï¼Œè¯•å›¾å®ˆæŠ¤å’Œå¹³ä¸æ­£ä¹‰ã€‚

  ä¸»è§’ä»¬é¢ä¸´ç€å‰æ‰€æœªæœ‰çš„è€ƒéªŒï¼Œä»–ä»¬çš„å†³å®šå°†å†³å®šæ•´ä¸ªé“¶æ²³ç³»çš„å‘½è¿ã€‚åœ¨è¿™ä¸ªå†²çªçš„èƒŒåï¼Œéšè—ç€æ·±å±‚çš„é˜´è°‹å’Œæ„å›¾ï¼Œæ¯ä¸ªè§’è‰²éƒ½è¢«æ¨å‘äº†è‡ªå·±ä¿¡ä»°å’Œä»·å€¼è§‚çš„è¾¹ç¼˜ã€‚å‹è°Šã€å‹‡æ°”å’ŒèƒŒå›äº¤ç»‡åœ¨ä¸€èµ·ï¼Œä¸ºè§‚ä¼—å‘ˆç°äº†ä¸€ä¸ªå……æ»¡æˆå‰§æ€§å’ŒæƒŠå–œçš„æ•…äº‹ã€‚

  ã€Šæ˜Ÿçƒå¤§æˆ˜ç¬¬ä¹å­£ã€‹ä¸ä»…æ˜¯ä¸€åœºå²è¯—èˆ¬çš„å†’é™©ï¼Œæ›´æ˜¯ä¸€æ®µå…³äºä¿¡å¿µã€æƒåŠ›å’Œè‡ªæˆ‘ç‰ºç‰²çš„æ¢ç´¢ã€‚åœ¨è¿™ä¸ªå®‡å®™ä¸­ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„è§’è‰²æ‰®æ¼”ï¼Œæ¯ä¸ªé€‰æ‹©éƒ½å°†äº§ç”Ÿæ·±è¿œçš„å½±å“ã€‚è¿™æ˜¯ä¸€åœºå…³äºå…‰æ˜ä¸é»‘æš—ä¹‹é—´æ°¸æ’å¯¹æŠ—çš„æˆå‰§ï¼Œä¹Ÿæ˜¯å…³äºå¸Œæœ›ä¸ç»æœ›çš„æ°¸æ’è¾ƒé‡ã€‚
  ã€Šæ˜Ÿçƒå¤§æˆ˜ç¬¬ä¹å­£ã€‹çš„èˆå°æ— ç–‘æ˜¯ä¸€ä¸ªæ˜Ÿé™…èˆå°ï¼Œä½†å…¶æ•…äº‹å´ç‰µåŠ¨ç€äººç±»å†…å¿ƒæœ€æ·±å¤„çš„æƒ…æ„Ÿå’Œä¿¡ä»°ã€‚è¿™éƒ¨å‰§é›†ä»¥å…¶éœ‡æ’¼äººå¿ƒçš„æˆ˜æ–—åœºé¢å’Œä»¤äººéš¾å¿˜çš„è§’è‰²å½¢è±¡ï¼Œå†æ¬¡å°†è§‚ä¼—å¸¦å…¥äº†ä¸€ä¸ªå……æ»¡å¥‡å¹»å’Œå†’é™©çš„ä¸–ç•Œã€‚

  æ•…äº‹çš„æ ¸å¿ƒæ˜¯ä¸€åœºæ—·æ—¥æŒä¹…çš„æ–—äº‰ï¼Œè¿™ä¸ä»…ä»…æ˜¯ä¸€åœºæ˜Ÿçƒä¹‹é—´çš„æˆ˜äº‰ï¼Œæ›´æ˜¯ä¸€åœºå¯¹ä¿¡å¿µå’Œè‡ªç”±çš„äº‰å¤ºã€‚ä¸»è§’ä»¬åœ¨å‘½è¿çš„æ“æ§ä¸‹ï¼Œè¢«è¿«é¢å¯¹è‰°éš¾çš„é€‰æ‹©ï¼Œä»–ä»¬çš„å†³å®šå°†ç›´æ¥å½±å“æ•´ä¸ªé“¶æ²³ç³»çš„æœªæ¥ã€‚è¿™ç§å†…åœ¨çš„å†²çªå’Œå¤–åœ¨çš„æˆ˜æ–—æ„æˆäº†å‰§é›†çš„æ ¸å¿ƒå¼ åŠ›ï¼Œä¹Ÿæ˜¯å¸å¼•è§‚ä¼—çš„é‡è¦å› ç´ ä¹‹ä¸€ã€‚

  åœ¨è¿™ä¸ªå®‡å®™ä¸­ï¼Œæ¯ä¸ªè§’è‰²éƒ½è¢«èµ‹äºˆäº†ç‹¬ç‰¹è€Œæ·±åˆ»çš„å†…å¿ƒä¸–ç•Œã€‚è§‚ä¼—å°†ç›®ç¹ä»–ä»¬çš„æˆé•¿ã€æŒ£æ‰å’Œå´›èµ·ï¼Œè¿™äº›éƒ½æ˜¯äººæ€§çš„çœŸå®å†™ç…§ã€‚å‹è°Šã€å‹‡æ°”å’ŒèƒŒå›äº¤ç»‡åœ¨ä¸€èµ·ï¼Œä¸ºè§‚ä¼—å‘ˆç°äº†ä¸€ä¸ªå……æ»¡æˆå‰§æ€§å’ŒæƒŠå–œçš„æ•…äº‹ã€‚

  é™¤äº†ä»¤äººæ¿€åŠ¨çš„æˆ˜æ–—åœºé¢å’Œç²¾å½©çš„ç‰¹æ•ˆå¤–ï¼Œã€Šæ˜Ÿçƒå¤§æˆ˜ç¬¬ä¹å­£ã€‹è¿˜æ¢ç´¢äº†ä¸€ç³»åˆ—æ·±åˆ»çš„ä¸»é¢˜ï¼Œå¦‚æƒåŠ›ã€è‡ªæˆ‘ç‰ºç‰²å’Œå¸Œæœ›ã€‚è¿™ä½¿å¾—å‰§é›†ä¸ä»…ä»…æ˜¯ä¸€åœºå¨±ä¹ï¼Œæ›´æ˜¯ä¸€æ¬¡å¯¹äººæ€§å’Œç¤¾ä¼šä»·å€¼è§‚çš„æ·±åº¦åæ€ã€‚

  æ€»çš„æ¥è¯´ï¼Œã€Šæ˜Ÿçƒå¤§æˆ˜ç¬¬ä¹å­£ã€‹æ˜¯ä¸€éƒ¨ä»¤äººå…´å¥‹çš„å²è¯—èˆ¬å†’é™©ï¼Œå®ƒå¼•äººå…¥èƒœçš„æ•…äº‹æƒ…èŠ‚å’Œæ·±åˆ»çš„ä¸»é¢˜ä½¿å…¶æˆä¸ºä¸€éƒ¨ä¸å®¹é”™è¿‡çš„ä½œå“ã€‚

  > Finished chain.
#+end_example

** ä½¿ç”¨ SequentialChain å®ç°æˆå‰§æ‘˜è¦å’Œè¯„è®ºï¼ˆå¤šè¾“å…¥/å¤šè¾“å‡ºï¼‰
#+ATTR_ORG: :width 800
[[../images/sequential_chain_0.png]]

#+begin_src jupyter-python :results none
  # # è¿™æ˜¯ä¸€ä¸ª LLMChainï¼Œæ ¹æ®å‰§åå’Œè®¾å®šçš„æ—¶ä»£æ¥æ’°å†™å‰§æƒ…ç®€ä»‹ã€‚
  llm = OpenAI(temperature=.7, max_tokens=1000, base_url=base_url)
  template = """ä½ æ˜¯ä¸€ä½å‰§ä½œå®¶ã€‚æ ¹æ®æˆå‰§çš„æ ‡é¢˜å’Œè®¾å®šçš„æ—¶ä»£ï¼Œä½ çš„ä»»åŠ¡æ˜¯ä¸ºè¯¥æ ‡é¢˜å†™ä¸€ä¸ªç®€ä»‹ã€‚

  æ ‡é¢˜ï¼š{title}
  æ—¶ä»£ï¼š{era}
  å‰§ä½œå®¶ï¼šä»¥ä¸‹æ˜¯å¯¹ä¸Šè¿°æˆå‰§çš„ç®€ä»‹ï¼š"""

  prompt_template = PromptTemplate(input_variables=["title", "era"], template=template)
  # output_key
  synopsis_chain = LLMChain(llm=llm, prompt=prompt_template, output_key="synopsis", verbose=True)
#+end_src

#+begin_src jupyter-python :results none
  # è¿™æ˜¯ä¸€ä¸ªLLMChainï¼Œç”¨äºæ ¹æ®å‰§æƒ…ç®€ä»‹æ’°å†™ä¸€ç¯‡æˆå‰§è¯„è®ºã€‚

  template = """ä½ æ˜¯ã€Šçº½çº¦æ—¶æŠ¥ã€‹çš„æˆå‰§è¯„è®ºå®¶ã€‚æ ¹æ®è¯¥å‰§çš„å‰§æƒ…ç®€ä»‹ï¼Œä½ éœ€è¦æ’°å†™ä¸€ç¯‡å…³äºè¯¥å‰§çš„è¯„è®ºã€‚

  å‰§æƒ…ç®€ä»‹ï¼š
  {synopsis}

  æ¥è‡ªã€Šçº½çº¦æ—¶æŠ¥ã€‹æˆå‰§è¯„è®ºå®¶å¯¹ä¸Šè¿°å‰§ç›®çš„è¯„ä»·ï¼š"""

  prompt_template = PromptTemplate(input_variables=["synopsis"], template=template)
  review_chain = LLMChain(llm=llm, prompt=prompt_template, output_key="review", verbose=True)
#+end_src

#+begin_src jupyter-python :results none
  from langchain.chains import SequentialChain

  m_overall_chain = SequentialChain(
      chains=[synopsis_chain, review_chain],
      input_variables=["era", "title"],
      # Here we return multiple variables
      output_variables=["synopsis", "review"],
      verbose=True)
#+end_src

#+begin_src jupyter-python
  m_overall_chain({"title":"ä¸‰ä½“äººä¸æ˜¯æ— æ³•æˆ˜èƒœçš„", "era": "äºŒåä¸€ä¸–çºªçš„æ–°ä¸­å›½"})
#+end_src

#+RESULTS:
#+begin_example


  [1m> Entering new SequentialChain chain...[0m


  [1m> Entering new LLMChain chain...[0m
  Prompt after formatting:
  [32;1m[1;3mä½ æ˜¯ä¸€ä½å‰§ä½œå®¶ã€‚æ ¹æ®æˆå‰§çš„æ ‡é¢˜å’Œè®¾å®šçš„æ—¶ä»£ï¼Œä½ çš„ä»»åŠ¡æ˜¯ä¸ºè¯¥æ ‡é¢˜å†™ä¸€ä¸ªç®€ä»‹ã€‚

  æ ‡é¢˜ï¼šä¸‰ä½“äººä¸æ˜¯æ— æ³•æˆ˜èƒœçš„
  æ—¶ä»£ï¼šäºŒåä¸€ä¸–çºªçš„æ–°ä¸­å›½
  å‰§ä½œå®¶ï¼šä»¥ä¸‹æ˜¯å¯¹ä¸Šè¿°æˆå‰§çš„ç®€ä»‹ï¼š[0m

  [1m> Finished chain.[0m


  [1m> Entering new LLMChain chain...[0m
  Prompt after formatting:
  [32;1m[1;3mä½ æ˜¯ã€Šçº½çº¦æ—¶æŠ¥ã€‹çš„æˆå‰§è¯„è®ºå®¶ã€‚æ ¹æ®è¯¥å‰§çš„å‰§æƒ…ç®€ä»‹ï¼Œä½ éœ€è¦æ’°å†™ä¸€ç¯‡å…³äºè¯¥å‰§çš„è¯„è®ºã€‚

  å‰§æƒ…ç®€ä»‹ï¼š


  åœ¨äºŒåä¸€ä¸–çºªçš„æ–°ä¸­å›½ï¼Œä¸€åœºå‰æ‰€æœªæœ‰çš„å±æœºé™ä¸´åˆ°äº†äººç±»çš„å¤´ä¸Šã€‚ä¸€ç¾¤æ¥è‡ªå¤–æ˜Ÿçš„ä¸‰ä½“äººå…¥ä¾µåœ°çƒï¼Œä»–ä»¬æ‹¥æœ‰è¶…å¼ºçš„ç§‘æŠ€å’Œæˆ˜æ–—åŠ›ï¼Œè®©äººç±»é™·å…¥äº†ç»å¢ƒã€‚ç„¶è€Œï¼Œé¢å¯¹è¿™æ ·çš„æ•Œäººï¼Œäººç±»å¹¶æ²¡æœ‰æŸæ‰‹å¾…æ¯™ï¼Œä»–ä»¬å›¢ç»“ä¸€å¿ƒï¼Œå‡­å€Ÿç€è‡ªå·±çš„æ™ºæ…§å’Œå‹‡æ°”ï¼Œå±•å¼€äº†ä¸€åœºç”Ÿæ­»ææ–—ã€‚

  åœ¨è¿™åœºæˆ˜äº‰ä¸­ï¼Œäººç±»çš„ç§‘å­¦å®¶ä»¬å‘æŒ¥ç€é‡è¦çš„ä½œç”¨ï¼Œä»–ä»¬ç ”ç©¶ä¸‰ä½“äººçš„ç§‘æŠ€ï¼Œè¯•å›¾æ‰¾åˆ°å¯¹æŠ—ä»–ä»¬çš„æ–¹æ³•ã€‚åŒæ—¶ï¼Œä¸€ä½å¹´è½»çš„å¥³ç§‘å­¦å®¶ä¹Ÿåœ¨è¿™æ¬¡å±æœºä¸­å‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œå¥¹ä¸ä»…åœ¨ç ”ç©¶ä¸­å‘ç°äº†ä¸‰ä½“äººçš„å¼±ç‚¹ï¼Œè¿˜å¸¦é¢†ç€äººç±»æˆ˜å£«ä»¬å‹‡æ•¢åœ°ä¸ä¸‰ä½“äººä½œæˆ˜ã€‚

  åœ¨æˆ˜äº‰çš„è¿‡ç¨‹ä¸­ï¼Œäººç±»ä¹Ÿå‘ç°äº†ä¸‰ä½“äººçš„å¼±ç‚¹å¹¶ä¸åªæ˜¯ä»–ä»¬çš„ç§‘æŠ€ï¼Œè¿˜æœ‰ç€ä»–ä»¬å†…å¿ƒçš„è½¯å¼±ã€‚éšç€æˆ˜äº‰çš„è¿›è¡Œï¼Œäººç±»å¼€å§‹åæ€è‡ªå·±ï¼Œæ€è€ƒä¸ä¸‰ä½“äººå’Œå¹³å…±å¤„çš„å¯èƒ½æ€§ã€‚æœ€ç»ˆï¼Œåœ¨ç»å†äº†ä¸€ç³»åˆ—çš„æŒ‘æˆ˜å’Œè€ƒéªŒåï¼Œäººç±»ä¸ä»…æˆ˜èƒœäº†ä¸‰ä½“äººï¼Œä¹Ÿæ‰¾åˆ°äº†ä¸ä»–ä»¬å’Œå¹³å…±å¤„çš„æ–¹æ³•ã€‚

  è¿™éƒ¨æˆå‰§è®²è¿°äº†äººç±»åœ¨é¢å¯¹å¼ºå¤§çš„å¤–æ•Œæ—¶çš„å‹‡æ°”å’Œæ™ºæ…§ï¼Œä¹Ÿåæ˜ äº†äººç±»çš„å†…å¿ƒä¸–ç•Œå’Œå¯¹å’Œå¹³çš„æ¸´æœ›ã€‚å®ƒå‘Šè¯‰æˆ‘ä»¬ï¼Œåœ¨å›°éš¾çš„æ—¶åˆ»ï¼Œå›¢ç»“ä¸€å¿ƒï¼Œå‹‡æ•¢åœ°é¢å¯¹æŒ‘æˆ˜ï¼Œäººç±»æ˜¯æ— æ³•è¢«å‡»è´¥çš„ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿå‘æˆ‘ä»¬å±•ç¤ºäº†ä¸€ç§å¯èƒ½ï¼Œå³ä¸åŒç§æ—ä¹‹é—´å¯ä»¥å’Œå¹³å…±å¤„ï¼Œè€Œä¸æ˜¯ä»…ä»…é€šè¿‡æˆ˜äº‰æ¥è§£å†³é—®é¢˜ã€‚è®©æˆ‘ä»¬ä¸€èµ·æ„Ÿå—è¿™åœºå…³äºå‹‡æ°”ã€æ™ºæ…§å’Œå’Œå¹³çš„æˆå‰§ï¼Œä¸€èµ·æ¢ç´¢äººç±»çš„æœªæ¥ã€‚

  æ¥è‡ªã€Šçº½çº¦æ—¶æŠ¥ã€‹æˆå‰§è¯„è®ºå®¶å¯¹ä¸Šè¿°å‰§ç›®çš„è¯„ä»·ï¼š[0m

  [1m> Finished chain.[0m

  [1m> Finished chain.[0m
#+end_example

** Homework
*** ä½¿ç”¨ OutputParser ä¼˜åŒ– overall_chain è¾“å‡ºæ ¼å¼ï¼ŒåŒºåˆ† synopsis_chain å’Œ review_chain çš„ç»“æœ
